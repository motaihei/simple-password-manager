# 25. パスワード保存場所設定機能の実装

## 実装日時
2025-06-26

## 実装した機能
設定ウィンドウでパスワードファイルの保存場所を変更できる機能を実装しました。

## 変更/作成したファイル

### 1. HTMLの更新 (`index.html`)
- 設定モーダル内に現在の保存場所表示と保存場所変更ボタンを追加
- `currentStoragePath` 要素で現在の保存場所を表示
- `changeStoragePathBtn` ボタンで保存場所変更機能にアクセス

### 2. メインプロセスの更新 (`main.js`)
- 設定ファイル管理機能を追加
  - `SETTINGS_FILE` 定数の追加
  - `loadSettings()` 関数：設定の読み込み
  - `saveSettings()` 関数：設定の保存
  - `initializeSettings()` 関数：アプリ起動時の設定初期化
- 新しいIPCハンドラーの追加
  - `load-settings`：設定データの読み込み
  - `save-settings`：設定データの保存
  - `select-storage-folder`：フォルダー選択ダイアログ
- パスワードファイルの動的パス管理
  - 設定に応じて `PASSWORD_FILE` パスを動的に更新
  - 保存時にディレクトリの自動作成

### 3. プリロードスクリプトの更新 (`preload.js`)
- 設定関連のAPI追加
  - `loadSettings()`：設定の読み込み
  - `saveSettings(settings)`：設定の保存
  - `selectStorageFolder()`：フォルダー選択ダイアログ

### 4. フロントエンドの更新 (`src/assets/js/app.js`)
- DOM要素の追加
  - `changeStoragePathBtn`：保存場所変更ボタン
  - `currentStoragePath`：現在の保存場所表示
- 新しいメソッドの追加
  - `loadSettings()`：設定の読み込みと表示更新
  - `handleChangeStoragePath()`：保存場所変更処理
- イベントリスナーの追加
  - 保存場所変更ボタンのクリックイベント
  - 設定ボタンクリック時の設定読み込み

## 主要な決定事項

### 1. 設定ファイルの構造
```json
{
  "storageLocation": "/path/to/storage/folder"
}
```
- シンプルな構造で将来的な拡張性を考慮
- デフォルト値は `app.getPath('userData')`

### 2. セキュリティ考慮事項
- フォルダー選択はElectronの公式ダイアログを使用
- パス検証とディレクトリ自動作成機能
- 既存ファイルの自動移動は行わず、ユーザーに手動コピーを促す

### 3. ユーザーエクスペリエンス
- 変更前に確認ダイアログを表示
- 現在の保存場所を分かりやすく表示
- 既存ファイルの扱いについて明確に説明

## 遭遇した問題と解決策

### 1. パスワードファイルの動的パス管理
**問題**: アプリ起動時とファイル操作時で設定が異なる可能性
**解決策**: 各ファイル操作前に設定を再読み込みして最新パスを取得

### 2. 既存データの扱い
**問題**: 保存場所変更時の既存データの移行方法
**解決策**: 自動移行はリスクが高いため、ユーザーに手動コピーを促すメッセージを表示

### 3. ディレクトリの存在確認
**問題**: 選択されたフォルダーが書き込み可能か不明
**解決策**: `fs.mkdir({ recursive: true })` でディレクトリを確保し、エラーハンドリングを実装

## 動作確認項目

1. ✅ 設定ウィンドウで現在の保存場所が表示される
2. ✅ 「保存場所を変更」ボタンでフォルダー選択ダイアログが開く
3. ✅ 新しい保存場所への変更が正常に保存される
4. ✅ 変更後の新規パスワード保存が新しい場所に行われる
5. ✅ アプリ再起動後も設定が維持される

## 今後の改善案

1. 既存ファイルの自動移行機能（オプション）
2. 保存場所のバックアップ機能
3. クラウドストレージ対応の検討
4. 設定のエクスポート/インポート機能